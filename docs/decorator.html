<!DOCTYPE html>  <html> <head>   <title>decorator.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="accessors.html">                 accessors.coffee               </a>                                           <a class="source" href="decorator.html">                 decorator.coffee               </a>                                           <a class="source" href="filters.html">                 filters.coffee               </a>                                           <a class="source" href="posture.html">                 posture.coffee               </a>                                           <a class="source" href="signals.html">                 signals.coffee               </a>                                           <a class="source" href="validators.html">                 validators.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               decorator.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Tests to see if our options object contains any of the appropriate functions for the decorator</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">noFuncs = </span><span class="nf">(options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>If it does, return false</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span>  <span class="p">[</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;wrap&#39;</span><span class="p">]</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">and</span> <span class="nx">isFn</span><span class="p">(</span><span class="nx">options</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>If it doesn't, return true</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Provides a Decorator pattern implementation for extending and wrapping Backbone objects and methods.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><strong>@param</strong> <em>{object}</em> options The options to configure the decorator</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Valid options are:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <ul>
<li>func:           the method or constructor that you want to decorate (Required)</li>
<li>before:         a function to be called prior to func with the same arguments (Optional)</li>
<li>after:          a function to be called after func with the same arguments (Optional)</li>
<li>wrap:           a function that accepts func as it first argument, wrapping and manipulating
              the return value (Optional) or the constructed object</li>
<li>context:        an object context to bind all of the functions above to when calling them</li>
<li>chain_returns:  the return value of each function (before, after, wrap) is appended to the
              arguments of the next function</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">decorator = </span><span class="nf">(options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>If we have not been give a function to decorate or any decorator functions then squawk!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">func</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">isFn</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">func</span><span class="p">)</span> <span class="o">or</span> <span class="nx">noFuncs</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">is</span> <span class="kc">true</span>
        <span class="k">throw</span> <span class="s2">&quot;A function to decorate and one or more of a before, after or wrapping function must be specified.&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If we have a wrapper function, wrap our original function (FN) in an outer wrapper that takes the arguments
intended for FN and pushes FN onto the front of the arguments array and then calls the inner wrapper (options.wrap)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">and</span> <span class="nx">isFn</span> <span class="nx">options</span><span class="p">.</span><span class="nx">wrap</span>
        <span class="nv">options.func = </span><span class="p">(</span><span class="nf">(opts) -&gt;</span>
            <span class="nf">(args...) -&gt;</span>
                <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">func</span>
                <span class="nx">opts</span><span class="p">.</span><span class="nx">wrap</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">context</span> <span class="o">or</span> <span class="err">@</span><span class="p">,</span> <span class="nx">args</span>
        <span class="p">)(</span><span class="nx">options</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Here we build our final function/constructor that will stand in for the original.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">final_func = </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Apply our before decorator (if it exists)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">before_return = </span><span class="nx">options</span><span class="p">.</span><span class="nx">before</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">args</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">before</span>
        </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If we are chaining, substitute before's return for the original arguments object</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chain_returns</span>
            <span class="nv">orig_args = </span><span class="nx">args</span>
            <span class="nv">args = </span><span class="nx">before_return</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Call the original or wrapped function, capturing it's output</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">orig_return = </span><span class="nx">options</span><span class="p">.</span><span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If we are chaining returns, append the original or wrapped function's return to the original arguments</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chain_returns</span>
            <span class="nv">args = </span><span class="nx">orig_args</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">orig_return</span><span class="p">])</span>
        <span class="nv">after_return = </span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">after</span> <span class="k">then</span> <span class="nx">options</span><span class="p">.</span><span class="nx">after</span><span class="p">.</span><span class="nx">apply</span> <span class="err">@</span><span class="p">,</span> <span class="nx">args</span> <span class="k">else</span> <span class="nx">orig_return</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If we are chaining returns, return the last return in the chain</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">chain_returns</span> <span class="k">then</span> <span class="nx">after_return</span> <span class="k">else</span> <span class="nx">orig_return</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>return a bound, decorated function if we have a binding context, else just return the deocorated function ###</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span> <span class="k">then</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">final_func</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">context</span> <span class="k">else</span> <span class="nx">final_func</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Convenience method to allow easy decoration of an object's methods. (Huh?)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <ul>
<li><strong>@param</strong> <em>{object}</em> obj         The object whose method we are decorating.</li>
<li><strong>@param</strong> <em>{string}</em> methodname  The name of the method that we are decorating.</li>
<li><strong>@param</strong> <em>{object}</em> options     An object containing the decorating configuration</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">decorator.decorateMethod = </span><span class="nf">(obj, methodName, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>If we are supposed to be working with the prototype, set obj to be obj's prototype</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">assignToProto</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">prototype</span>
        <span class="nv">obj = obj::</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If we have not been given an object or a method name or any decorator functions squawk! </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">obj</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">methodName</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">options</span> <span class="o">or</span> <span class="nx">noFuncs</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
        <span class="k">throw</span> <span class="s2">&quot;decorateMethod requires an object and method name and one or more of before, after and wrap options&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Extend the options array with the additional func and context properties (if appropriate)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">options</span><span class="p">,</span>
        <span class="nv">func: </span><span class="nx">obj</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">or</span> <span class="o">-&gt;</span>
        <span class="nv">context: </span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">addContext</span> <span class="o">is</span> <span class="kc">true</span><span class="p">)</span> <span class="k">then</span> <span class="nx">obj</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>decorate the method and return it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">obj</span><span class="p">[</span><span class="nx">methodname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">decorator</span> <span class="nx">options</span>
    <span class="k">return</span> <span class="kc">true</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 